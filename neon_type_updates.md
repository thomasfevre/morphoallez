PostgreSQL Schema Optimization for Morpho Event Data
Author: Thomas 

Date: August 15, 2025

1. Introduction
This document outlines the process and rationale for optimizing the PostgreSQL database schema generated by rindexer. The initial schema, while functional, used generic data types (CHAR, VARCHAR(78), NUMERIC for integers) that were suboptimal for storing blockchain data.

The goal of this refactoring was to enforce data integrity, improve storage efficiency, and enhance query performance by selecting the most precise and appropriate data type for each column.

2. Guiding Principles
The schema alterations were guided by three core principles:

Data Integrity: Using precise types acts as a validation layer at the database level. For example, an address column should not be able to store a 66-character transaction hash.

Storage Efficiency: Choosing the smallest appropriate data type for a given value reduces the overall database size, leading to lower storage costs and faster backups.

Query Performance: Operations on native binary types (like BIGINT or INTEGER) are significantly faster than on text-based or arbitrary-precision types (VARCHAR, NUMERIC). Correct typing is crucial for efficient joins, aggregations, and filtering.

3. Data Type Mapping Strategy
The following table summarizes the strategy used to map the initial data types to their optimized counterparts.

| Data Category | Example Value | Initial Type | Optimized Type | Rationale |
| Address | 0xae7...c6393 | CHAR(42) | VARCHAR(42) | VARCHAR avoids inefficient space-padding used by CHAR. The length constraint ensures only valid 42-character addresses are stored. |
| Transaction/Block Hash | 0xb7e...40ce8 | CHAR(66) | VARCHAR(66) | Same as addresses. VARCHAR is more storage-efficient, and the length constraint enforces a valid 66-character hash format. |
| Large Token Amounts | 1818...9844 | VARCHAR(78) | NUMERIC | These values often exceed the BIGINT limit. NUMERIC is the only type that guarantees arbitrary precision for these massive integers, making them available for accurate mathematical operations. |
| Block Number | 18900000 | NUMERIC | BIGINT | Block numbers are large whole numbers that fit comfortably within a BIGINT. This type is significantly more performant and storage-efficient than NUMERIC for this use case. |
| Index (Tx, Log) | 123 | NUMERIC | INTEGER | These are small, non-negative whole numbers. INTEGER is the most efficient type, using only 4 bytes of storage. |
| Raw Bytes (Market ID) | 0x... | BYTEA | BYTEA | No change. BYTEA (byte array) is the correct and most efficient type for storing raw bytes32 data from smart contracts. |

4. SQL Implementation Scripts
The following SQL scripts were executed to apply the schema optimizations. The USING clause was employed to safely cast data from its original text-based format to the new, strongly-typed format.=================================================================
-- Schema: morpho_blue_etl_meta_morpho__steakhouse__usdc
-- =================================================================

-- Table: deposit
ALTER TABLE "morpho_blue_etl_meta_morpho__steakhouse__usdc"."deposit"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "sender" SET DATA TYPE VARCHAR(42) USING trim("sender"),
ALTER COLUMN "owner" SET DATA TYPE VARCHAR(42) USING trim("owner"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: reallocate_supply
ALTER TABLE "morpho_blue_etl_meta_morpho__steakhouse__usdc"."reallocate_supply"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "id" SET DATA TYPE VARCHAR(66),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "supplied_assets" SET DATA TYPE NUMERIC USING "supplied_assets"::NUMERIC,
ALTER COLUMN "supplied_shares" SET DATA TYPE NUMERIC USING "supplied_shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: reallocate_withdraw
ALTER TABLE "morpho_blue_etl_meta_morpho__steakhouse__usdc"."reallocate_withdraw"
ALTER COLUMN "id" SET DATA TYPE VARCHAR(66),
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "withdrawn_assets" SET DATA TYPE NUMERIC USING "withdrawn_assets"::NUMERIC,
ALTER COLUMN "withdrawn_shares" SET DATA TYPE NUMERIC USING "withdrawn_shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: withdraw
ALTER TABLE "morpho_blue_etl_meta_morpho__steakhouse__usdc"."withdraw"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "sender" SET DATA TYPE VARCHAR(42) USING trim("sender"),
ALTER COLUMN "receiver" SET DATA TYPE VARCHAR(42) USING trim("receiver"),
ALTER COLUMN "owner" SET DATA TYPE VARCHAR(42) USING trim("owner"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;


-- =================================================================
-- Schema: morpho_blue_etl_meta_morpho_v1_1_factory
-- =================================================================

-- Table: create_meta_morpho
ALTER TABLE "morpho_blue_etl_meta_morpho_v1_1_factory"."create_meta_morpho"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "meta_morpho" SET DATA TYPE VARCHAR(42) USING trim("meta_morpho"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "initial_owner" SET DATA TYPE VARCHAR(42) USING trim("initial_owner"),
ALTER COLUMN "asset" SET DATA TYPE VARCHAR(42) USING trim("asset"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "initial_timelock" SET DATA TYPE BIGINT USING "initial_timelock"::BIGINT,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;


-- =================================================================
-- Schema: morpho_blue_etl_morpho__blue
-- =================================================================

-- Table: accrue_interest
ALTER TABLE "morpho_blue_etl_morpho__blue"."accrue_interest"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "prev_borrow_rate" SET DATA TYPE NUMERIC USING "prev_borrow_rate"::NUMERIC,
ALTER COLUMN "interest" SET DATA TYPE NUMERIC USING "interest"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: borrow
ALTER TABLE "morpho_blue_etl_morpho__blue"."borrow"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "receiver" SET DATA TYPE VARCHAR(42) USING trim("receiver"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: create_market
ALTER TABLE "morpho_blue_etl_morpho__blue"."create_market"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "market_params_loan_token" SET DATA TYPE VARCHAR(42) USING trim("market_params_loan_token"),
ALTER COLUMN "market_params_collateral_token" SET DATA TYPE VARCHAR(42) USING trim("market_params_collateral_token"),
ALTER COLUMN "market_params_oracle" SET DATA TYPE VARCHAR(42) USING trim("market_params_oracle"),
ALTER COLUMN "market_params_irm" SET DATA TYPE VARCHAR(42) USING trim("market_params_irm"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "market_params_lltv" SET DATA TYPE NUMERIC USING "market_params_lltv"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: flash_loan
ALTER TABLE "morpho_blue_etl_morpho__blue"."flash_loan"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "token" SET DATA TYPE VARCHAR(42) USING trim("token"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: repay
ALTER TABLE "morpho_blue_etl_morpho__blue"."repay"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: supply
ALTER TABLE "morpho_blue_etl_morpho__blue"."supply"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: supply_collateral
ALTER TABLE "morpho_blue_etl_morpho__blue"."supply_collateral"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: withdraw
ALTER TABLE "morpho_blue_etl_morpho__blue"."withdraw"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "receiver" SET DATA TYPE VARCHAR(42) USING trim("receiver"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "shares" SET DATA TYPE NUMERIC USING "shares"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: withdraw_collateral
ALTER TABLE "morpho_blue_etl_morpho__blue"."withdraw_collateral"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "caller" SET DATA TYPE VARCHAR(42) USING trim("caller"),
ALTER COLUMN "on_behalf" SET DATA TYPE VARCHAR(42) USING trim("on_behalf"),
ALTER COLUMN "receiver" SET DATA TYPE VARCHAR(42) USING trim("receiver"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "assets" SET DATA TYPE NUMERIC USING "assets"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;


-- =================================================================
-- Schema: morpho_blue_etl_public_allocator
-- =================================================================

-- Table: public_reallocate_to
ALTER TABLE "morpho_blue_etl_public_allocator"."public_reallocate_to"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "sender" SET DATA TYPE VARCHAR(42) USING trim("sender"),
ALTER COLUMN "vault" SET DATA TYPE VARCHAR(42) USING trim("vault"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "supplied_assets" SET DATA TYPE NUMERIC USING "supplied_assets"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;

-- Table: public_withdrawal
ALTER TABLE "morpho_blue_etl_public_allocator"."public_withdrawal"
ALTER COLUMN "contract_address" SET DATA TYPE VARCHAR(42) USING trim("contract_address"),
ALTER COLUMN "sender" SET DATA TYPE VARCHAR(42) USING trim("sender"),
ALTER COLUMN "vault" SET DATA TYPE VARCHAR(42) USING trim("vault"),
ALTER COLUMN "tx_hash" SET DATA TYPE VARCHAR(66) USING trim("tx_hash"),
ALTER COLUMN "block_hash" SET DATA TYPE VARCHAR(66) USING trim("block_hash"),
ALTER COLUMN "withdrawn_assets" SET DATA TYPE NUMERIC USING "withdrawn_assets"::NUMERIC,
ALTER COLUMN "block_number" SET DATA TYPE BIGINT USING "block_number"::BIGINT,
ALTER COLUMN "tx_index" SET DATA TYPE INTEGER USING "tx_index"::INTEGER,
ALTER COLUMN "log_index" SET DATA TYPE INTEGER USING "log_index"::INTEGER;
